#include <stdio.h>   //THIS IS THE FINALIZED WORKING CODE!
#include <string.h>
#include <ctype.h>
#define size 100

typedef struct {
    int ID;
    char Name[31];
    int Quantity;
} Medicine;

typedef struct {
    int ID;
    char Name[31];
    char Number[16];
} Supplier;

typedef struct {
    int ID;
    char name[50];
    int contact;
} Customer;

// Validation Functions
int ValidateId(int id){ //Checks if Id is valid
    if(id<0){
        printf("Invalid Id\n");
        return 0;
    }
    else
        return 1;
}
int ValidateName(char name[],char Section){  //Checks if name is valid
    char message[10];
    switch (Section){   //Use same function for sections with different output messages
        case 'M':
            strcpy(message,"Medicine");
            break;
        case 'S':
            strcpy(message,"Supplier");
            break;
    }
    int flag=1;
    for(int a=0;name[a]!='\0';a++){
        if(!isalpha(name[a]) && !isspace(name[a])){
            flag=0; 
            break;
        }
    }
    if(!flag)
        printf("%s name can only contain alphabhets\n",message);
    return flag;
}
int ValidateQuantity(int quantity){ //Checks if quantity is valid
    if(quantity<0){
            printf("Quantity cannot be less than zero\n");
            return 0;    
    }
    else
        return 1;
}
int ValidateNumber(char number[]){  //Validates phone number
    if(strlen(number)<10){
        printf("Phone number must contain atleast 10 digits\n");
        return 0;
    }
    for(int a=0;number[a]!='\0';a++){
        if(!isdigit(number[a])){
            printf("Phone number can only contain numbers\n");
            return 0;
        }
    }
    return 1;
}
// Medicine Functions
int LoadData(Medicine MedicineData[],int *ptr){
    FILE *fptr=fopen("medicine.txt","r");
    if(fptr==NULL){ //Error handling
        fptr = fopen("medicine.txt", "w");
        if (fptr != NULL)
        {
            fclose(fptr);
            printf("\nMedicine database file created.\n");
        }
        return 1;   
    }
    //Read data and store it in array of medicine structure for faster processing
    while(fscanf(fptr,"ID:%d,Name:%[^,],Quantity:%d\n",&MedicineData[*ptr].ID,MedicineData[*ptr].Name,&MedicineData[*ptr].Quantity)!=EOF){
        (*ptr)++;   
    }
    fclose(fptr);
    printf("\nMedicine records loaded from file.\n");
    return 1;
}
void SaveData(Medicine MedicineData[],int NoOfMedicine){
    FILE *fptr=fopen("medicine.txt","w");
    if(fptr==NULL)  //Error handling
        printf("Error in saving changes to file 'medicine.txt'\n");
    else{
        for(int a=0;a<NoOfMedicine;a++){    //Copy all data from arrays to the file before termination of program
            fprintf(fptr,"ID:%d,Name:%s,Quantity:%d\n",MedicineData[a].ID,MedicineData[a].Name,MedicineData[a].Quantity);
        }
    }
    fclose(fptr);
}
void AddMedicine(Medicine MedicineData[],int *ptr){
    if(*ptr>size-1) //Check if Inventory is full
        printf("Inventory is full\n");
    else{
        int Id;
        do{
            printf("Enter medicine Id \n");
            scanf("%d",&Id);
        }while(!ValidateId(Id));    //Validates user input of Id
        scanf("%*c");
        int Flag=0,x=0;
        while(x<*ptr){  //Prevent duplication of same medicine
            if(MedicineData[x].ID==Id){
                Flag=1;
                break;
            }
            x++;
        }
        if(Flag==1)
            printf("This medicine already exists in the inventory\n");
        else{
            int quantity;
            char name[31];
            do{
                printf("Enter medicine name.It cannot be more than 30 characters \n");
                fgets(name,31,stdin);
                name[strcspn(name,"\n")]='\0';
            }while(!ValidateName(name,'M'));    //Validates user input of medicine name
            do{
                printf("Enter quantity of the medicine \n");
                scanf("%d",&quantity);
            }while(!ValidateQuantity(quantity));    //Validates user input of quantity
            MedicineData[*ptr].ID=Id;
            MedicineData[*ptr].Quantity=quantity;
            strcpy(MedicineData[*ptr].Name,name);
            (*ptr)++;   //Increase the count of medicines
            printf("New medicine added successfully\n");
        }
    }
    printf("---------------------------------------------\n");
}
int SearchMedicine(Medicine MedicineData[],int NoOfMedicine){
    int Id,found=-1;
    do{
        printf("Enter medicine Id \n");
        scanf("%d",&Id);
    }while(!ValidateId(Id));    //Validates user input of Id
    scanf("%*c");
    for(int a=0;a<NoOfMedicine;a++){
        if(MedicineData[a].ID==Id){
            found=a;    //Stores the index at which the medicine is found
            break;
        }
    }
    return found;
}
void ModifyMedicine(Medicine MedicineData[],int NoOfMedicine){
    int option,quantity;
    char name[31];
    int index=SearchMedicine(MedicineData,NoOfMedicine);  //Uses search function to check if medicine exists or not
    if(index==-1)   
        printf("Medicine Id does not exist\n");
    else{    
        do{
            printf("If you want to change only medicine name,enter 1 or enter 2 for only changing quantity or enter 3 for both \n");
            scanf("%d",&option);
        }while(option<1||option>3);
        scanf("%*c");
        switch (option){
        case 3: //Uses concept of fall-through in switch cases for option 3
        case 1:
            do{
                printf("Enter the new medicine name.It cannot be more than 30 characters \n");
                fgets(name,31,stdin);
                name[strcspn(name,"\n")]='\0';
            }while(!ValidateName(name,'M'));
            strcpy(MedicineData[index].Name,name);
            printf("Medicine name updated successfully\n");
            if(option==1)
                break;
        case 2:
            do{
                printf("Enter the new quantity of the medicine \n");
                scanf("%d",&quantity);
            }while(!ValidateQuantity(quantity));
            MedicineData[index].Quantity=quantity;
            printf("Medicine quantity updated successfully\n");
            break;
        }
    }
    printf("--------------------------------------\n");
}
void DeleteMedicine(Medicine MedicineData[],int *ptr){
    int index=SearchMedicine(MedicineData,*ptr);
    if(index==-1)
        printf("Medicine Id does not exist\n");
    else{
        for(int a=index;a<*ptr-1;a++){    //Deletes the record by shifting each record back by one index
            MedicineData[a].ID=MedicineData[a+1].ID;
            MedicineData[a].Quantity=MedicineData[a+1].Quantity;
            strcpy(MedicineData[a].Name,MedicineData[a+1].Name);
        }
        (*ptr)--;   //Updates the value of number of medicines
        printf("Medicine record deleted successfully\n");
    }
    printf("------------------------------------\n");
}
void DisplayInventory(Medicine MedicineData[],int NoOfMedicine){
    printf("%-5s%-15s%-10s\n", "Id", "Name", "Quantity");
    for(int a=0;a<NoOfMedicine;a++){
        printf("%-5d%-15s%-10d\n",MedicineData[a].ID,MedicineData[a].Name,MedicineData[a].Quantity);
    }
    printf("----------------------------\n");
}
// Supplier Functions
int ReadData(Supplier SupplierData[],int *ptr){
    FILE *fptr=fopen("supplier.txt","r");
    if(fptr==NULL){ //Error handling
        fptr = fopen("supplier.txt", "w");
        if (fptr != NULL)
        {
            fclose(fptr);
            printf("\nSupplier database file created.\n");
        }
        return 1;   
    }
    //Read data and store it in array of supplier structure for faster processing
    while(fscanf(fptr,"ID:%d,Name:%[^,],Phone Number:%s\n",&SupplierData[*ptr].ID,SupplierData[*ptr].Name,&SupplierData[*ptr].Number)!=EOF){
        (*ptr)++;   
    }
    fclose(fptr);
    printf("\nSupplier records loaded from file.\n");
    return 1;
}
void WriteData(Supplier SupplierData[],int NoOfSupplier){
    FILE *fptr=fopen("supplier.txt","w");
    if(fptr==NULL)  //Error handling
        printf("Error in saving changes to file 'supplier.txt'\n");
    else{
        for(int a=0;a<NoOfSupplier;a++){    //Copy all data from arrays to the file before termination of program
            fprintf(fptr,"ID:%d,Name:%s,Phone Number:%s\n",SupplierData[a].ID,SupplierData[a].Name,SupplierData[a].Number);
        }
        printf("Changes saved successfully\n");
    }
    fclose(fptr);
}
void AddSupplier(Supplier SupplierData[],int *ptr){
    if(*ptr>size-1) //Check if there is space for another record
        printf("No space for another record\n");
    else{
        int Id;
        do{
            printf("Enter supplier Id \n");
            scanf("%d",&Id);
        }while(!ValidateId(Id));    //Validates user input of Id
        scanf("%*c");
        int Flag=0,x=0;
        while(x<*ptr){  //Prevent duplication of same supplier
            if(SupplierData[x].ID==Id){
                Flag=1;
                break;
            }
            x++;
        }
        if(Flag==1)
            printf("This supplier already exists in the records\n");
        else{
            char name[31],number[16];
            
            do{
                printf("Enter supplier name.It cannot be more than 30 characters \n");
                fgets(name,31,stdin);
                name[strcspn(name,"\n")]='\0';
            }while(!ValidateName(name,'S'));    //Validates user input of supplier name
            do{
                printf("Enter phone number of supplier \n");
                fgets(number,16,stdin);
                number[strcspn(number,"\n")]='\0';
            }while(!ValidateNumber(number));    //Validates user input of phone number
            SupplierData[*ptr].ID=Id;
            strcpy(SupplierData[*ptr].Name,name);
            strcpy(SupplierData[*ptr].Number,number);
            (*ptr)++;   //Increase the count of suppliers
            printf("New supplier record added successfully\n");
        }
    }
    printf("---------------------------------------------\n");
}
int SearchSupplier(Supplier SupplierData[],int NoOfSupplier){
    int Id,found=-1;
    do{
        printf("Enter supplier Id \n");
        scanf("%d",&Id);
    }while(!ValidateId(Id));    //Validates user input of Id
    scanf("%*c");
    for(int a=0;a<NoOfSupplier;a++){
        if(SupplierData[a].ID==Id){
            found=a;    //Stores the index at which the supplier record is found
            break;
        }
    }
    return found;

}
void ModifySupplier(Supplier SupplierData[],int NoOfSupplier){
    int option;
    char name[31],number[16];
    int index=SearchSupplier(SupplierData,NoOfSupplier);  //Uses search function to check if supplier record exists or not
    if(index==-1)   
        printf("Supplier Id does not exist\n");
    else{    
        do{
            printf("If you want to change only supplier name,enter 1 or enter 2 for only changing phone number or enter 3 for both \n");
            scanf("%d",&option);
        }while(option<1||option>3);
        scanf("%*c");
        switch (option){
        case 3: //Uses concept of fall-through in switch cases for option 3
        case 1:
            do{
                printf("Enter the new supplier name.It cannot be more than 30 characters \n");
                fgets(name,31,stdin);
                name[strcspn(name,"\n")]='\0';
            }while(!ValidateName(name,'S'));
            strcpy(SupplierData[index].Name,name);
            printf("Supplier name updated successfully\n");
            if(option==1)
                break;
        case 2:
            do{
                printf("Enter the new phone number of the supplier \n");
                scanf("%15s",number);
            }while(!ValidateNumber(number));
            strcpy(SupplierData[index].Number,number);
            printf("Supplier phone number updated successfully\n");
            break;
        }
    }
    printf("---------------------------------------------\n");
}
void DeleteSupplier(Supplier SupplierData[],int *ptr){
    int index=SearchSupplier(SupplierData,*ptr);
    if(index==-1)
        printf("Supplier Id does not exist\n");
    else{
        for(int a=index;a<*ptr-1;a++){    //Deletes the record by shifting each record back by one index
            SupplierData[a].ID=SupplierData[a+1].ID;
            strcpy(SupplierData[a].Name,SupplierData[a+1].Name);
            strcpy(SupplierData[a].Number,SupplierData[a+1].Number);
        }
        (*ptr)--;   //Updates the value of number of suppliers
        printf("Supplier record deleted successfully\n");
    }
    printf("------------------------------------\n");
}
void DisplaySupplierRecords(Supplier SupplierData[],int NoOfSupplier){
    printf("%-5s%-15s%-10s\n", "Id", "Name", "Phone Number");
    for(int a=0;a<NoOfSupplier;a++){
        printf("%-5d%-15s%-14s\n",SupplierData[a].ID,SupplierData[a].Name,SupplierData[a].Number);
    }
    printf("-----------------------------\n");
}

//  CUSTOMER SECTION FUNCTIONS
void loadCustomersFromFile()
{
    FILE *file = fopen("Customers.txt", "r");
    
    if (file == NULL)
    {
        file = fopen("Customers.txt", "w");
        if (file != NULL)
        {
            fclose(file);
            printf("\nCustomer database file created.\n");
        }
        return;
    }
    
    fclose(file);
    printf("\nCustomer records loaded from file.\n");
}

void saveCustomerToFile(Customer customer)
{
    FILE *file = fopen("Customers.txt", "a");
    
    if (file == NULL)
    {
        printf("\nError: Could not open file for writing!");
        return;
    }
    
    fprintf(file, "%d|%s|%d\n", customer.ID, customer.name, customer.contact);
    
    fclose(file);
}

int customerExists(int ID)
{
    FILE *file = fopen("Customers.txt", "r");
    
    if (file == NULL)
    {
        return 0;
    }
    
    Customer temp;
    while (fscanf(file, "%d|%[^|]|%d\n", &temp.ID, temp.name, &temp.contact) == 3)
    {
        if (temp.ID == ID)
        {
            fclose(file);
            return 1;
        }
    }
    
    fclose(file);
    return 0;
}

void addCustomer(int ID, char name[], int contact)
{
    if (ID <= 0)
    {
        printf("\nError: ID must be a positive number!");
        return;
    }
    
    if (contact <= 0)
    {
        printf("\nError: Contact number must be a positive number!");
        return;
    }
    
    if (strlen(name) == 0 || name[0] == '\0')
    {
        printf("\nError: Name cannot be empty!");
        return;
    }
    
    if (customerExists(ID))
    {
        printf("\nThis customer already exists, enter a different ID!");
        return;
    }
    
    Customer newCustomer;
    newCustomer.ID = ID;
    strcpy(newCustomer.name, name);
    newCustomer.contact = contact;
    
    saveCustomerToFile(newCustomer);
    printf("\nCustomer added successfully!");
}

void SearchRecord(int ID)
{
    FILE *file = fopen("Customers.txt", "r");
    
    if (file == NULL)
    {
        printf("\nNo records found!");
        return;
    }
    
    Customer temp;
    int found = 0;
    
    while (fscanf(file, "%d|%[^|]|%d\n", &temp.ID, temp.name, &temp.contact) == 3)
    {
        if (temp.ID == ID)
        {
            printf("\nRecord found, fetching info...");
            printf("\nCustomer ID: %d", temp.ID);
            printf("\nCustomer Name: %s", temp.name);
            printf("\nCustomer Contact: %d", temp.contact);
            found = 1;
            break;
        }
    }
    
    if (!found)
    {
        printf("\nRecord Not Found, enter a valid ID!");
    }
    
    fclose(file);
}

void printAllRecords()
{
    FILE *file = fopen("Customers.txt", "r");
    
    printf("\n\t--ALL RECORDS--\t\n");
    
    if (file == NULL)
    {
        printf("\nNo records found!\n");
        return;
    }
    
    Customer temp;
    int count = 0;
    
    while (fscanf(file, "%d|%[^|]|%d\n", &temp.ID, temp.name, &temp.contact) == 3)
    {
        printf("\nID: %d\tName: %s\tContact: %d", temp.ID, temp.name, temp.contact);
        count++;
    }
    
    if (count == 0)
    {
        printf("\nNo records found!\n");
    }
    
    fclose(file);
}
void CustomerSection()
{
    int subinput;
    int Id, Id_2, Contact;
    char Name[50];

    loadCustomersFromFile(); 

    do {
        printf("\n\n\t--CUSTOMER MENU--\t");
        printf("\n\tEnter between 1 to 4 to perform an operation");
        printf("\n\t1 - Add a Customer record");
        printf("\n\t2 - Search for a customer record");
        printf("\n\t3 - Print All Records");
        printf("\n\t4 - Exit Customer Section");
        printf("\n\tEnter: ");
        scanf("%d", &subinput);

        switch (subinput) {
            case 1:
                printf("\nEnter ID: ");
                scanf("%d", &Id);
                getchar();
                printf("Enter Name: ");
                fgets(Name, 50, stdin);
                Name[strcspn(Name, "\n")] = 0;
                printf("Enter Contact: ");
                scanf("%d", &Contact); 
                addCustomer(Id, Name, Contact);
                break;
            case 2:
                printf("\nEnter ID of record to search: ");
                scanf("%d", &Id_2);
                SearchRecord(Id_2);
                break;
            case 3:
                printAllRecords();
                break;
            case 4:
                printf("\nExited the Customer Section.\n");
                break;
            default:
                printf("\nInvalid number entered!");
                break;
        }
    } while (subinput != 4);
}
// Main Function

int main(){
    Medicine MedicineData[size];
    Supplier SupplierData[size];
    int userinput,subinput,NoOfMedicine=0,NoOfSupplier=0;
    int open1=LoadData(MedicineData,&NoOfMedicine);
    int open2=ReadData(SupplierData,&NoOfSupplier);
    printf("Welcome to Medicine Record Managment System!");
    do{
        printf("\nMain Menu.To:\nGo to Medicine Section,enter 1\nGo to Supplier Section,enter 2\nGo to Customer Section,enter 3\nExit the main menu,enter 4\n");
        scanf("%d",&userinput);
        switch (userinput){
            case 1:
                printf("Medicine Section\n");
                if(open1){
                    do{
                        printf("To:\nAdd a new medicine record,enter 1\nSearch for a medicine,enter 2\nModify an existing record,enter 3\nDelete a existing record,enter 4\nDisplay inventory,enter 5\nExit the medicine section,enter 6 \n");
                        scanf("%d",&subinput);
                        switch (subinput){
                            case 1:
                                AddMedicine(MedicineData,&NoOfMedicine);
                                break;
                            case 2:
                                {
                                    int result=SearchMedicine(MedicineData,NoOfMedicine);
                                    (result==-1)?printf("Medicine not found in inventory\n"):printf("Medicine %s with quantity %d found at index %d\n",MedicineData[result].Name,MedicineData[result].Quantity,result);
                                    printf("-------------------------------------\n");
                                }
                                break;
                            case 3:
                                ModifyMedicine(MedicineData,NoOfMedicine);
                                break;
                            case 4:
                                DeleteMedicine(MedicineData,&NoOfMedicine);
                                break;
                            case 5:
                                DisplayInventory(MedicineData,NoOfMedicine);
                                break;
                            case 6:
                                printf("Exitted the medicine section\n");
                                break;
                            default:
                                printf("Invalid option\n");
                        }
                    }while(subinput!=6);
                }
                break;
            case 2:
                printf("Supplier Section\n");
                if(open2){
                    do{
                        printf("To:\nAdd a new supplier,enter 1\nSearch for a supplier,enter 2\nModify an existing supplier record,enter 3\nDelete a existing supplier record,enter 4\nDisplay all records,enter 5\nExit the supplier section,enter 6 \n");
                        scanf("%d",&subinput);
                        switch (subinput){
                            case 1:
                                AddSupplier(SupplierData,&NoOfSupplier);
                                break;
                            case 2:
                                {
                                    int result=SearchSupplier(SupplierData,NoOfSupplier);
                                    (result==-1)?printf("Supplier not found in records\n"):printf("Supplier %s with Id %d and phone number %s found at index %d\n",SupplierData[result].Name,SupplierData[result].ID,SupplierData[result].Number,result);
                                    printf("-------------------------------------------------\n");
                                }
                                break;
                            case 3:
                                ModifySupplier(SupplierData,NoOfSupplier);
                                break;
                            case 4:
                                DeleteSupplier(SupplierData,&NoOfSupplier);
                                break;
                            case 5:
                                DisplaySupplierRecords(SupplierData,NoOfSupplier);
                                break;
                            case 6:
                                printf("Exitted the supplier section\n");
                                break;
                            default:
                                printf("Invalid option\n");
                        }
                    }while(subinput!=6);
                }
                break;
            case 3:
            printf("Customer Section\n");
            CustomerSection();
            break;
            case 4:
                printf("Saving changes.....\n");
                SaveData(MedicineData,NoOfMedicine);
                WriteData(SupplierData,NoOfSupplier);
                printf("Exitted the main menu\n");
                break;
            default:
                printf("Invaild option\n");
        }
    }while(userinput!=4);   
} 
